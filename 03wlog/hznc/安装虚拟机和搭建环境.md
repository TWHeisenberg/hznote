# 安装虚拟机和搭建环境

## 安装centos(7.4)

## 配置网络

	[root@vm01-192 ~]# vim /etc/sysconfig//network-scripts/ifcfg-ens33
	TYPE=Ethernet
	PROXY_METHOD=none
	BROWSER_ONLY=no
	DEFROUTE=yes
	IPV4_FAILURE_FATAL=no
	IPV6INIT=yes
	IPV6_AUTOCONF=yes
	IPV6_DEFROUTE=yes
	IPV6_FAILURE_FATAL=no
	IPV6_ADDR_GEN_MODE=stable-privacy
	NAME=ens33
	DEVICE=ens33
	# 主要修改下面的配置
	BOOTPROTO=static
	ONBOOT=yes
	IPADDR=192.168.198.101
	GATEWAY=192.168.198.2
	NETMASK=255.255.255.0
	# 配置域名服务器
	DNS1=8.8.8.8
	DNS2=8.8.4.4

## 配置yum源

```sh
# 备份并移除老的repo
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

yum clean all
yum makecache
```
## 基础配置，关闭防火墙，配置ssh等

### 配置ssh

```shell
# 生成公钥
ssh-keygen -o
# 复制公钥
ssh-copy-id vm01
```
### 关闭防火墙

```shell
# 停止防火墙
systemctl stop firewalld.service
# 查看状态
systemctl status firewalld.service
# 永久关闭
systemctl disable firewalld.service
```
### 配置ntp

​	TODO

### 关闭SELinux

```shell
# 查看状态
/usr/sbin/sestatus -v
# 关闭,disable掉
vim /etc/selinux/config
# 改成SELINUX=disabled
```


# 搭建hadoop集群



## 安装zookeeper

```shell
# 下载并解压zk压缩包
tar -zxvf zookeeper-3.4.8.tar.gz  -C /opt
cd /opt && ln -s  zookeeper-3.4.8 zookeeper

# 修改配置
vim conf/zoo.cfg
# 配置如下：
dataDir=/opt/zookeeper/data
dataLogDir=/opt/zookeeper/logs
clientPort=2181
server.1=vm01:2888:3888

# 配置myid
echo 1 > /opt/zookeeper/data/myid

#启动
bash bin/zkServer.sh start

# 确认
bash bin/zkServer.sh status
# 看到下面结果：
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/bin/../conf/zoo.cfg
Mode: standalone
```



## 安装hadoop

```shell
# 下载并解压

# 修改配置文件
core-site.xml
yarn-site.xml
mapred-site.xml
hdfs-site.xml
slaves
hadoop-env.sh # 配置JAVA_HOME

# 格式化hdfs的namenode
hadoop namenode -format
# 启动namenode
hadoop-daemon.sh start namenode
# 确认日志
tail -f /opt/hadoop/logs *.log

# 如果启动HA(两个namenode)
    # 在namenode2机器上同步
    hadoop namenode -bootstrapStandby
    # 启动zkfc
    hadoop-daemon.sh start zkfc
    # 这时两个节点一个standby一个active

# 启动secondarynamenode
hadoop-daemon.sh start secondarynamenode

# 启动datanode
hadoop-daemons.sh start datanode

# 启动yarn
start-yarn.sh

tips:
# 启动hdfs
start-dfs.sh
# 关闭hdfs
stop-dfs.sh
# 启动zkclient，并连接zookeeper集群
/opt/zookeeper/bin/zkCli.sh -server master:2181,slave1:2181,slave2:2181
# 启动yarn
start-yarn.sh
	#  	yarn，单独启动的方式
		yarn-daemon.sh start resourcemanager
# 查看zk状态
/opt/zookeeper/bin/zkServer.sh status
# hdfs ui界面
http://192.168.198.101:50070/dfshealth.html#tab-overview
# yarn ui界面
http://192.168.198.101:8088/

# hbase ui界面
http://192.168.198.101:60010/master-status#compactStas
# 关闭集群hbase：
stop-hbase.sh
# 启动/关闭hbase所有：
hbase-daemons.sh start/stop regionserver
# 开启、关闭hbase单独
hbase-daemon.sh start/stop regionserver
hbase-daemon.sh start/stop master


# jps
24912 ResourceManager
24625 NameNode
25106 NodeManager
28962 QuorumPeerMain
25507 SecondaryNameNode
24788 DataNode
34907 HMaster
35934 Jps

```

## 安装hbase

```shell
# 下载并解压安装包
tar -zxvf hbase-1.3.1-bin.tar.gz -C /opt
# 创建软连接
cd /opt && ln -s hbase-1.3.1-bin.tar.gz hbase 
# 修改配置
hbase-site.xml
regionservers
hbase-env.sh # 配置JAVA_HOME
	# 配置zk
    export HBASE_MANAGES_ZK=true # 通过hbase来管理zk,但如果是外部的zk就不能让hbase来管理
    export HBASE_PID_DIR=/opt/data/hbase
# 通过hbase启动zk
hbase-daemons.sh start zookeeper
# 启动
start-hbase.sh
# 查看日志确认，jps
# hbase shell

# 启动集群
	# 先启动zk
	bash /opt/zookeeper/bin/zkServer.sh start
	bash /opt/zookeeper/bin/zkServer.sh status
	# 启动hadoop
	hadoop-daemon.sh start namenode
	hadoop-daemon.sh start secondarynamenode
	hadoop-daemon.sh start datanode
	# 启动hbase
	start-hbase.sh
	# 如果是c++去连接，hbase默认支持java去连接，如果是c++要启动thrift2,端口默认是9090
	hbase-deamon.sh start thrift2

```



## 问题

```
java.io.IOException: Incompatible clusterIDs in /opt/hadoop-data/dfs/data
解决：
执行hdfs namenode -format后，current目录会删除并重新生成，其中VERSION文件中的clusterID也会随之变化，而datanode的VERSION文件中的clusterID保持不变，造成两个clusterID不一致。

  所以为了避免这种情况，可以再执行的namenode格式化之后，删除datanode的current文件夹，或者修改datanode的VERSION文件中出clusterID与namenode的VERSION文件中的clusterID一样，然后重新启动dfs。
```

```
RROR: org.apache.hadoop.hbase.ipc.ServerNotRunningYetException: Server is not running yet

关闭hadoop的安全模式：
hdfs dfsadmin -safemode get
hdfs dfsadmin -safemode leave
# 重启hbase
```

```
maven 编译报错：
java.lang.ArrayIndexOutOfBoundsException: 8377
        at org.codehaus.plexus.util.xml.pull.MXParser.parsePI(MXParser.java:2502)
 
 升级maven试试

```

```
报错：
网络不通，ifconfig 查看网卡没有起来
service network restart 查看报错：
Failed to start LSB: Bring up/down networking.

查看日志：cat /var/log/message

rtnetlink answers: file exists

原因：
NetworkManager 服务和network冲突了，关掉前者
service NetworkManager stop # systemctl stop NetworkManager
chkconfig NetworkManager off # 禁止开机启动

# 重启网络
service network restart
```

